#!/bin/bash

#1i
. /opt/ownsec/ITSEC-Install-Scripts-ORIG/001.functions/all-scripts.sh

GITREPO=https://github.com/rapid7/metasploit-framework
BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
RBENVEXECDIR=/opt/ownsec/ITSEC-Install-Scripts-ORIG/3.Exploitation-Tools/metasploit/rbenv-sh
GITCLONEDIR=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7
EXECUTEABLE1=msfconsole.sh 
EXECUTEABLE2=msfd.sh 
EXECUTEABLE3=msfrpc.sh 
EXECUTEABLE4=msfrpcd.sh
EXECUTEABLE5=msfvenom.sh
EXECUTEABLE6=msfbinscan.sh
EXECUTEABLE7=msfelfscan.sh
EXECUTEABLE8=msfmachscan.sh 
EXECUTEABLE9=msfpescan.sh
EXECUTEABLE10=msfupdate.sh
EXECUTEABLE11=msfconsole
EXECUTEABLE12=msfd
EXECUTEABLE13=msfrpc
EXECUTEABLE14=msfrpcd
EXECUTEABLE15=msfvenom
EXECUTEABLE16=msfbinscan
EXECUTEABLE17=msfelfscan
EXECUTEABLE18=msfmachscan
EXECUTEABLE19=msfpescan
EXECUTEABLE20=msfupdate
DSKTPFLS=/opt/ownsec/ITSEC-Install-Scripts-ORIG/3.Exploitation-Tools/metasploit-framework
DSKTPFLSDEST=/home/$USER/.local/share/applications/3.Exploitation-Tools/metasploit-framework
DSKTPFL1=msfconsole.desktop
DSKTPFL2=msfbinscan.desktop
DSKTPFL3=msfelfscan.desktop
DSKTPFL4=msfmachscan.desktop
DSKTPFL5=msfpescan.desktop
DSKTPFL6=msfrop.desktop
DSKTPFL7=msfvenom.desktop
DSKTPFL8=msfupdate.desktop
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
APTLSTDIR=/opt/ownsec/ITSEC-Install-Scripts-ORIG/3.Exploitation-Tools/metasploit-framework

#ph1a

echo "${bold}
 __  __ _____ _____  _    ____  ____  _     ___ ___ _____ 
|  \/  | ____|_   _|/ \  / ___||  _ \| |   / _ \_ _|_   _|
| |\/| |  _|   | | / _ \ \___ \| |_) | |  | | | | |  | |  
| |  | | |___  | |/ ___ \ ___) |  __/| |__| |_| | |  | |  
|_|  |_|_____| |_/_/   \_\____/|_|   |_____\___/___| |_|  
           
INSTALL
rapid7/metasploit-framework
# installation script by alphaaurigae
${normal}"

echo "GITCLONEFUNC"
#plh11
GITCLONEFUNC

cd $GITREPOROOT
### DEPS:
echo "Install deps"
sudo apt-get update
sudo apt-get upgrade
xargs -a <(awk '/^\s*[^#]/' "$APTLSTDIR/deps-metasploit.txt") -r -- sudo apt-get install -y
source ~/.bashrc
eval "$(rbenv init -)"
yes "N" | rbenv install $RUBYVERSION
rbenv rehash

rbenv shell $RUBYVERSION 
### DEPS END
echo "bundle install"
cd $GITREPOROOT
GITSBMDLINIT

#sudo chown -R $USER:$USER /home/$USER
gem install bundler
bundle install

echo "write the app files"
echo '
#!/bin/bash 

echo "running msfconsole with rbenv"
BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
#rbenv shell 2.4.1 
cd $GITREPOROOT
echo $RUBYVERSION
ruby -v
rbenv sudo ./msfconsole "$@"' > $GITREPOROOT/$EXECUTEABLE1
chmod +x $GITREPOROOT/$EXECUTEABLE1


echo '#!/bin/bash 


BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfd "$@"' > $GITREPOROOT/$EXECUTEABLE2
chmod +x $GITREPOROOT/$EXECUTEABLE2


echo '#!/bin/bash 

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfrpc "$@"' > $EXECUTEABLE3
chmod +x $EXECUTEABLE3


echo '#!/bin/bash 

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfrpcd "$@"' > $GITREPOROOT/$EXECUTEABLE4
chmod +x $GITREPOROOT/$EXECUTEABLE4


echo '#!/bin/bash

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfvenom "$@"' > $EXECUTEABLE5
chmod +x $EXECUTEABLE5

echo '#!/bin/bash

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfbinscan "$@"' > $GITREPOROOT/$EXECUTEABLE6
chmod +x $GITREPOROOT/$EXECUTEABLE6

echo '#!/bin/bash 

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfelfscan "$@"' > $EXECUTEABLE7
chmod +x $EXECUTEABLE7

echo '#!/bin/bash

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfmachscan "$@"' > $GITREPOROOT/$EXECUTEABLE8
chmod +x $GITREPOROOT/$EXECUTEABLE8

echo '#!/bin/bash

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfpescan "$@"' > $GITREPOROOT/$EXECUTEABLE9
chmod +x $GITREPOROOT/$EXECUTEABLE9

echo '#!/bin/bash 

. /opt/ownsec/ITSEC-Install-Scripts-ORIG/001.functions/all-scripts.sh

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )

cd $GITREPOROOT

echo "running with rbenv"
. ~/.bashrc
eval "$(rbenv init -)"
yes "N" | rbenv install $RUBYVERSION
rbenv rehash
sudo updatedb
sudo ldconfig
rbenv shell $RUBYVERSION
 
cd $GITREPOROOT
GITSBMDLINIT
git pull
gem install bundler
bundle install
 ' > $GITREPOROOT/$EXECUTEABLE10
chmod +x $GITREPOROOT/$EXECUTEABLE10

echo "rm old symlinks"
sudo rm -f /usr/local/bin/msf*
# sudo bash -c 'for MSF in $(ls msf*); do ln -s $GITREPOROOT/$MSF /usr/local/bin/$MSF;done'
echo "create new symlinks"
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 /usr/local/bin/$EXECUTEABLE11
sudo ln -s $GITREPOROOT/$EXECUTEABLE2 /usr/local/bin/$EXECUTEABLE12
sudo ln -s $GITREPOROOT/$EXECUTEABLE3 /usr/local/bin/$EXECUTEABLE13
sudo ln -s $GITREPOROOT/$EXECUTEABLE4 /usr/local/bin/$EXECUTEABLE14
sudo ln -s $GITREPOROOT/$EXECUTEABLE5 /usr/local/bin/$EXECUTEABLE15
sudo ln -s $GITREPOROOT/$EXECUTEABLE6 /usr/local/bin/$EXECUTEABLE16
sudo ln -s $GITREPOROOT/$EXECUTEABLE7 /usr/local/bin/$EXECUTEABLE17
sudo ln -s $GITREPOROOT/$EXECUTEABLE8 /usr/local/bin/$EXECUTEABLE18
sudo ln -s $GITREPOROOT/$EXECUTEABLE9 /usr/local/bin/$EXECUTEABLE19
sudo ln -s $GITREPOROOT/$EXECUTEABLE10 /usr/local/bin/$EXECUTEABLE20

echo "rm old config file"
rm -f $GITREPOROOT/config/database.yml
cat > $GITREPOROOT/config/database.yml << EOF
production:
    adapter: postgresql
    database: msf
    username: msf
    password: msf
    host: 127.0.0.1
    port: 5432
    pool: 75
    timeout: 5
EOF

echo "write config file locatio nto etc profile"
sudo sh -c "echo export MSF_DATABASE_CONFIG=$GITREPOROOT/config/database.yml >> /etc/profile"
source /etc/profile
sudo ldconfig
sudo updatedb
echo "msfconsole version test"
msfconsole --version

echo "copy desktop files"

# del old .desktop file dir
rm -rf /home/robotux/.local/share/applications/3.Exploitation-Tools/MSF
rm -rf $DSKTPFLSDEST
mkdir -p $DSKTPFLSDEST
rm -f $DSKTPFLSDEST/$DSKTPFL1 && cp $DSKTPFLS/$DSKTPFL1 $DSKTPFLSDEST/$DSKTPFL1
rm -f $DSKTPFLSDEST/$DSKTPFL2 && cp $DSKTPFLS/$DSKTPFL2 $DSKTPFLSDEST/$DSKTPFL2
rm -f $DSKTPFLSDEST/$DSKTPFL3 && cp $DSKTPFLS/$DSKTPFL3 $DSKTPFLSDEST/$DSKTPFL3
rm -f $DSKTPFLSDEST/$DSKTPFL4 && cp $DSKTPFLS/$DSKTPFL4 $DSKTPFLSDEST/$DSKTPFL4
rm -f $DSKTPFLSDEST/$DSKTPFL5 && cp $DSKTPFLS/$DSKTPFL5 $DSKTPFLSDEST/$DSKTPFL5
rm -f $DSKTPFLSDEST/$DSKTPFL6 && cp $DSKTPFLS/$DSKTPFL6 $DSKTPFLSDEST/$DSKTPFL6
rm -f $DSKTPFLSDEST/$DSKTPFL7 && cp $DSKTPFLS/$DSKTPFL7 $DSKTPFLSDEST/$DSKTPFL7
rm -f $DSKTPFLSDEST/$DSKTPFL8 && cp $DSKTPFLS/$DSKTPFL8 $DSKTPFLSDEST/$DSKTPFL8
echo "done"