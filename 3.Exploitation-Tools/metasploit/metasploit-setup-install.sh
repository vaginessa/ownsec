#!/bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

GITREPO=https://github.com/rapid7/metasploit-framework
BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
RBENVEXECDIR=/opt/ITSEC-Install-Scripts/3.Exploitation-Tools/metasploit/rbenv-sh
GITCLONEDIR=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7
EXECUTEABLE1=msfconsole.sh 
EXECUTEABLE2=msfd.sh 
EXECUTEABLE3=msfrpc.sh 
EXECUTEABLE4=msfrpcd.sh
EXECUTEABLE5=msfvenom.sh
EXECUTEABLE6=msfbinscan.sh
EXECUTEABLE7=msfelfscan.sh
EXECUTEABLE8=msfmachscan.sh 
EXECUTEABLE9=msfpescan.sh
EXECUTEABLE10=msfupdate.sh
EXECUTEABLE11=msfconsole
EXECUTEABLE12=msfd
EXECUTEABLE13=msfrpc
EXECUTEABLE14=msfrpcd
EXECUTEABLE15=msfvenom
EXECUTEABLE16=msfbinscan
EXECUTEABLE17=msfelfscan
EXECUTEABLE18=msfmachscan
EXECUTEABLE19=msfpescan
EXECUTEABLE20=msfupdate
BINDIR=/usr/local/bin
DSKTPFLS=/opt/ITSEC-Install-Scripts/0.Initial/usrlcl/.local/share/applications/3.Exploitation-Tools/MSF
DSKTPFLSDEST=/home/$USER/.local/share/applications/3.Exploitation-Tools/MSF
DSKTPFL1=msfconsole.desktop
DSKTPFL2=msfbinscan.desktop
DSKTPFL3=msfelfscan.desktop
DSKTPFL4=msfmachscan.desktop
DSKTPFL5=msfpescan.desktop
DSKTPFL6=msfrop.desktop
DSKTPFL7=msfvenom.desktop
DSKTPFL7=msfupdate.desktop
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
APTLSTDIR=/opt/ITSEC-Install-Scripts/0.Initial/lst/apt
GITSBMDLINIT () {
	git submodule init
	git submodule update --recursive
	sudo updatedb && sudo ldconfig
}

echo "${bold}
 __  __ _____ _____  _    ____  ____  _     ___ ___ _____ 
|  \/  | ____|_   _|/ \  / ___||  _ \| |   / _ \_ _|_   _|
| |\/| |  _|   | | / _ \ \___ \| |_) | |  | | | | |  | |  
| |  | | |___  | |/ ___ \ ___) |  __/| |__| |_| | |  | |  
|_|  |_|_____| |_/_/   \_\____/|_|   |_____\___/___| |_|  
           
INSTALL
${normal}"


mkdir -p $GITCLONEDIR
cd $GITCLONEDIR
git clone -b $BRANCH $GITREPO
cd $GITREPOROOT

### DEPS:
## Installed w apt lists - see /opt/ITSEC-Install-Scripts/0.Initial/lst/apt
# sudo apt-get update
# sudo apt-get upgrade
# xargs -a <(awk '/^\s*[^#]/' "$APTLSTDIR/deps-metasploit.txt") -r -- sudo apt-get install -y
source ~/.bashrc
eval "$(rbenv init -)"
yes "N" | rbenv install $RUBYVERSION
rbenv rehash

rbenv shell $RUBYVERSION 
### DEPS END

APTLSTDIR=/opt/ITSEC-Install-Scripts/0.Initial/lst/apt
GITSBMDLINIT

sudo gem install bundler
bundle install

echo '
#!/bin/bash 

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
#rbenv shell 2.4.1 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
echo $RUBYVERSION
ruby -v
./msfconsole ' > $EXECUTEABLE1
chmod +x $EXECUTEABLE1


echo '#!/bin/bash 

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
./msfd ' > $EXECUTEABLE2
chmod +x $EXECUTEABLE2


echo '#!/bin/bash 

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
./msfrpc ' > $EXECUTEABLE3
chmod +x $EXECUTEABLE3


echo '#!/bin/bash 

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
./msfrpcd ' > $EXECUTEABLE4
chmod +x $EXECUTEABLE4


echo '#!/bin/bash

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
./msfvenom ' > $EXECUTEABLE5
chmod +x $EXECUTEABLE5

echo '#!/bin/bash

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
./msfbinscan ' > $EXECUTEABLE6
chmod +x $EXECUTEABLE6

echo '#!/bin/bash 

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
./msfelfscan ' > $EXECUTEABLE7
chmod +x $EXECUTEABLE7

echo '#!/bin/bash

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
./msfmachscan ' > $EXECUTEABLE8
chmod +x $EXECUTEABLE8

echo '#!/bin/bash

BRANCH=master
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
./msfpescan ' > $EXECUTEABLE9
chmod +x $EXECUTEABLE9

echo '#!/bin/bash 

GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
cd $GITREPOROOT

if git diff-index --quiet HEAD --; then
    echo "UP TO DATE"
else

cd /opt/ITSEC-Install-Scripts/3.Exploitation-Tools/metasploit
./metasploit-setup.sh
fi ' > $EXECUTEABLE10
chmod +x $EXECUTEABLE10



sudo rm -f $BINDIR/msf*
# sudo bash -c 'for MSF in $(ls msf*); do ln -s /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework/$MSF $BINDIR/$MSF;done'


sudo rm -f $BINDIR/$EXECUTEABLE11
sudo rm -f $BINDIR/$EXECUTEABLE12
sudo rm -f $BINDIR/$EXECUTEABLE13
sudo rm -f $BINDIR/$EXECUTEABLE14
sudo rm -f $BINDIR/$EXECUTEABLE15
sudo rm -f $BINDIR/$EXECUTEABLE16
sudo rm -f $BINDIR/$EXECUTEABLE17
sudo rm -f $BINDIR/$EXECUTEABLE18
sudo rm -f $BINDIR/$EXECUTEABLE19
sudo rm -f $BINDIR/$EXECUTEABLE20

sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE11
sudo ln -s $GITREPOROOT/$EXECUTEABLE2 $BINDIR/$EXECUTEABLE12
sudo ln -s $GITREPOROOT/$EXECUTEABLE3 $BINDIR/$EXECUTEABLE13
sudo ln -s $GITREPOROOT/$EXECUTEABLE4 $BINDIR/$EXECUTEABLE14
sudo ln -s $GITREPOROOT/$EXECUTEABLE5 $BINDIR/$EXECUTEABLE15
sudo ln -s $GITREPOROOT/$EXECUTEABLE6 $BINDIR/$EXECUTEABLE16
sudo ln -s $GITREPOROOT/$EXECUTEABLE7 $BINDIR/$EXECUTEABLE17
sudo ln -s $GITREPOROOT/$EXECUTEABLE8 $BINDIR/$EXECUTEABLE18
sudo ln -s $GITREPOROOT/$EXECUTEABLE9 $BINDIR/$EXECUTEABLE19
sudo ln -s $GITREPOROOT/$EXECUTEABLE10 $BINDIR/$EXECUTEABLE20

cat > $GITREPOROOT/config/database.yml << EOF
production:
    adapter: postgresql
    database: msf
    username: msf
    password: msf
    host: 127.0.0.1
    port: 5432
    pool: 75
    timeout: 5
EOF

sudo sh -c "echo export MSF_DATABASE_CONFIG=$GITREPOROOT/config/database.yml >> /etc/profile"
source /etc/profile
sudo ldconfig
sudo updatedb
msfconsole --version
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL1 $DSKTPFLSDEST/$DSKTPFL1
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL2 $DSKTPFLSDEST/$DSKTPFL2
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL3 $DSKTPFLSDEST/$DSKTPFL3
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL4 $DSKTPFLSDEST/$DSKTPFL4
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL5 $DSKTPFLSDEST/$DSKTPFL5
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL6 $DSKTPFLSDEST/$DSKTPFL6
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL7 $DSKTPFLSDEST/$DSKTPFL7
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL8 $DSKTPFLSDEST/$DSKTPFL8
echo "done"