#!/bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

echo "${bold}
  ___  ____  _____ _   ___     ___    ____  ___    ____    _    ____  _   _ 
 / _ \|  _ \| ____| \ | \ \   / / \  / ___|/ _ \  | __ )  / \  / ___|| | | |
| | | | |_) |  _| |  \| |\ \ / / _ \ \___ \ (_) | |  _ \ / _ \ \___ \| |_| |
| |_| |  __/| |___| |\  | \ V / ___ \ ___) \__, | | |_) / ___ \ ___) |  _  |
 \___/|_|   |_____|_| \_|  \_/_/   \_\____/  /_/  |____/_/   \_\____/|_| |_|
 ${normal}"


###WORKS
###TO-DO: 
#Add menu entry link and startstop
############################# PREQUISITES START #############################
# 1. It is expected that the Openvas9 target INSTALLDIR PATH is already in place. 
#    This Script will fail if the targt folder is not in place
#
# 2. Tried my very best to avoid adding unessary apt repositories to teh dependencies to be installed, however, 
#    due to the amount of trail and error im just done with it now.
#
# ~. Why so complicated if ther eare apt repositories? ... BECAUSE ....
#
############################# PREQUISITES END #############################

#######################################################################
############################# SETUP START #############################
#######################################################################

############################# VARIABLES START #############################
INSTALLDIR=/opt/ITSEC/2.Vulnerability-Analysis/1.Vulnerability-Scanner/openvas
setupfilesdir=/opt/ITSEC-Install-Scripts/2.Vulnerability-Analysis/1.Vulnerability-Scanner/openvas-setup-files
menuconsolescripts=/opt/ITSEC-Install-Scripts/2.Vulnerability-Analysis/1.Vulnerability-Scanner/openvas-setup-files/menu_console-scripts
#########SYMLINK
startall=openvas-start_all.sh
stopall=openvas-kill_all.sh
checksetup=openvas9-checksetup.sh
updateall=openvas-update-all.sh
###
startallsymlink=openvas-start_all
stopallsymlink=openvas-kill_all
checksetupsymlink=openvas9-checksetup
updateallsymlink=openvas-update-all

#########SYMLINK END

#Location of the new openvassd.conf
openvassdconf=/opt/ITSEC-Install-Scripts/2.Vulnerability-Analysis/1.Vulnerability-Scanner/openvas-setup-files/conf-files/openvassd.conf
#Location of menu files
menufilesdir=/opt/ITSEC-Install-Scripts/2.Vulnerability-Analysis/1.Vulnerability-Scanner/openvas-setup-files/menu_console-scripts/desktop-files

#Install 
LIBRARIES=openvas-libraries-9.0.1
LIBRARIESURL=http://wald.intevation.org/frs/download.php/2420/openvas-libraries-9.0.1.tar.gz
SCANNER=openvas-scanner-5.1.1
SCANNERURL=http://wald.intevation.org/frs/download.php/2423/openvas-scanner-5.1.1.tar.gz
MANAGER=openvas-manager-7.0.1
MANAGERURL=http://wald.intevation.org/frs/download.php/2426/openvas-manager-7.0.1.tar.gz
GSAD=greenbone-security-assistant-7.0.2
GSADURL=http://wald.intevation.org/frs/download.php/2429/greenbone-security-assistant-7.0.2.tar.gz
CLI=openvas-cli-1.4.5
CLIURL=http://wald.intevation.org/frs/download.php/2397/openvas-cli-1.4.5.tar.gz

SMB=openvas-smb-1.0.2
SMBURL=http://wald.intevation.org/frs/download.php/2377/openvas-smb-1.0.2.tar.gz

OSPD=ospd-1.2.0
OSPDURL=http://wald.intevation.org/frs/download.php/2401/ospd-1.2.0.tar.gz

DEBSECAN=ospd-debsecan-1.2b1
DEBSECANURL=http://wald.intevation.org/frs/download.php/2405/ospd-debsecan-1.2b1.tar.gz

NMAP=ospd-nmap-1.0b1
NMAPURL=http://wald.intevation.org/frs/download.php/2218/ospd-nmap-1.0b1.tar.gz
############################# VARIABLE END #############################
#
############################# STATIC FUNCTIONS START #############################

#

DSKTPFLS=/opt/ITSEC-Install-Scripts/0.Initial/usrlcl/.local/share/applications/2.Vulnerability-Analysis/1.Vulnerability-Scanner
DSKTPFLSDEST=/home/$USER/.local/share/applications/2.Vulnerability-Analysis/1.Vulnerability-Scanner
DSKTPFL1=openvas-feed-update.desktop
DSKTPFL2=openvas-start.desktop
DSKTPFL3=openvas-stop.desktop
############################# STATIC FUNCTIONS END #############################
#
############################# MAIN SETUP START #############################


sudo ldconfig
sudo updatedb

sudo rm -r $INSTALLDIR
mkdir -p $INSTALLDIR
cd $INSTALLDIR/


#############################  STEP 2 - Load, Build and Install START #############################

	wget $LIBRARIESURL
	tar xvfz $LIBRARIES.tar.gz
	cd $LIBRARIES
	mkdir build
	cd build
	cmake ..
	make -j 2
	sudo make install
	cd ../..

sudo ldconfig
sudo updatedb
	wget $SCANNERURL
	tar xvfz $SCANNER.tar.gz
	cd $SCANNER
	mkdir build
	cd build
	cmake ..
	make -j 2
	sudo make install
	cd ../..

sudo ldconfig
sudo updatedb
	wget $MANAGERURL
	tar xvfz $MANAGER.tar.gz
	cd $MANAGER
	mkdir build
	cd build
	cmake ..
	make -j 2
	sudo make install
	cd ../..

sudo ldconfig
sudo updatedb
	wget $GSADURL
	tar xvfz $GSAD.tar.gz
	cd $GSAD
	mkdir build
	cd build
	cmake ..
	make -j 2
	sudo make install
	cd ../..

sudo ldconfig
sudo updatedb
	wget $CLIURL
	tar xvfz $CLI.tar.gz
	cd $CLI
	mkdir build
	cd build
	cmake ..
	make -j 2
	sudo make install
	cd ../..

sudo ldconfig
sudo updatedb
	wget $SMBURL
	tar xvfz $SMB.tar.gz
	cd $SMB
	# PATCH-HACK SOURCE http://lists.wald.intevation.org/pipermail/openvas-devel/2016-May/003712.html
	# PATCH-HACK Remove the line containing the string "gnutls_certificate_type_set_priority," by using:
	sed -i /gnutls_certificate_type_set_priority/d $INSTALLDIR/openvas-smb-1.0.2/samba/lib/tls/tls.c
	mkdir build
	cd build
	cmake ..
	make -j 2
	sudo make install
	cd ../..


	wget $OSPDURL
	tar xvfz $OSPD.tar.gz
	cd $OSPD
	sudo python setup.py install
	cd ..

sudo ldconfig
sudo updatedb

	wget $DEBSECANURL
	tar xvfz $DEBSECAN.tar.gz
	cd $DEBSECAN
	sudo python setup.py install
	cd ..

sudo ldconfig
sudo updatedb
	wget $NMAPURL
	tar xvfz $NMAP.tar.gz
	cd $NMAP
	sudo python setup.py install
	cd ..
sudo ldconfig
sudo updatedb

############################# STEP 2 - STEP 2 - Load, Build and Install END #############################
#
############################# STEP 3 - SERVICE SETUP AND UPDATE START #############################

#Fix redis.conf socket settings for openvas
#1.delete old entries
sudo sed -i.old '/^[#*-]\{0,1\}unixsocket/d' /etc/redis/redis.conf
#2.paste new settings
sudo echo '
unixsocket /var/run/redis/redis.sock
unixsocketperm 700' | sudo tee --append /etc/redis/redis.conf


#Symlink 
#start all 
sudo rm -f /usr/local/bin/$startallsymlink
sudo ln -s $menuconsolescripts/$startall /usr/local/bin/$startallsymlink
#stop all 
sudo rm -f /usr/local/bin/$stopallsymlink
sudo ln -s $menuconsolescripts/$stopall /usr/local/bin/$stopallsymlink
#check setup
sudo rm -f /usr/local/bin/$checksetupsymlink
sudo ln -s $menuconsolescripts/$checksetup /usr/local/bin/$checksetupsymlink
#check sync all
sudo rm -f /usr/local/bin/$updateallsymlink
sudo ln -s $menuconsolescripts/$updateall /usr/local/bin/$updateallsymlink

#Copy install repo openvassd.conf with REDIS socks settings to openvas installation.
sudo cp $openvassdconf /usr/local/etc/openvas/openvassd.conf 

sudo service apache2 stop
sudo service apache2 start
sudo service php7.0-fpm stop
sudo service php7.0-fpm start
sudo service redis-server stop
sudo service redis-server start

#Sync
sudo greenbone-scapdata-sync
sudo greenbone-certdata-sync
sudo greenbone-nvt-sync 

#Create certificates
sudo openvas-manage-certs -a

#Delete old user, create new user and put pass in textfile
sudo openvasmd --delete-user=admin
sudo openvasmd --create-user=admin --role=Admin > $INSTALLDIR/admin.txt

#Restart Services
sudo openvas-kill_all
sudo openvas-start_all

sudo openvasmd --update --progress
sudo openvasmd --rebuild --progress

#Restart Services
sudo openvas-kill_all
sudo openvas-start_all


#Copy .desktop menu files
cp $menufilesdir/* /home/$USER/.local/share/applications/2.Vulnerability-Analysis/1.Vulnerability-Scanner/


#Check Installation
sudo openvas9-checksetup 
sudo ps aux | egrep "(openvas.d|gsad)"


#Installation User Info console output
echo "${bold}OPENVAS 9 ADMIN DASHBOARD https://127.0.0.1:9392${normal}"
echo "${bold}admin password at $INSTALLDIR/admin.txt ${normal}"
echo "STEP 3 - Service Setup and Update - COMPLETE ..."
echo "${bold}Installer Complete ... if it doesent work, read the console print :) ${normal}"
echo "${bold}If checksetup complains about permissions, do sudo ${normal}"
echo "${bold}If setup failed may rerun sudo "openvasmd --rebuild --progress" and the update ...${normal}"
echo "${bold} may also restart apache2, redis-server and php${normal}"
echo "made this script to save time - if it served you, share, improve, share again... opensource is awesome"


cd $INSTALLDIR

############################# STEP 3 - SERVICE SETUP AND UPDATE END #############################
#

mkdir -p $DSKTPFLSDEST 
cp $DSKTPFLS/$DSKTPFL1 $DSKTPFLSDEST/$DSKTPFL1
cp $DSKTPFLS/$DSKTPFL2 $DSKTPFLSDEST/$DSKTPFL2
cp $DSKTPFLS/$DSKTPFL3 $DSKTPFLSDEST/$DSKTPFL3

############################# MAIN SETUP END #############################
#
############################# SETUP END #############################
