#!/bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

GITREPO=https://github.com/andresriancho/w3af.git
GITREPOROOT=/opt/ITSEC/2.Vulnerability-Scanner/w3af/andresriancho/w3af
GITCLONEDIR=/opt/ITSEC/2.Vulnerability-Scanner/w3af/andresriancho
EXECUTEABLE1=w3af_console
EXECUTEABLE1GUI=w3af_gui
EXECUTEABLE1SH=w3af_console.sh
EXECUTEABLE1GUISH=w3af_gui.sh
BINDIR=/usr/local/bin
DSKTPFLS=/opt/ITSEC-Install-Scripts/0.Initial/usrlcl/.local/share/applications/2.Vulnerability-Scanner
DSKTPFLSDEST=/home/$USER/.local/share/applications/2.Vulnerability-Scanner
DSKTPFL=w3af-GUI.desktop
GITSBMDLINIT () {
	git submodule init
	git submodule update --recursive
	sudo updatedb && sudo ldconfig
}

echo "${bold}
__        _______   _    _____ 
\ \      / /___ /  / \  |  ___|
 \ \ /\ / /  |_ \ / _ \ | |_   
  \ V  V /  ___) / ___ \|  _|  
   \_/\_/  |____/_/   \_\_|    
           
INSTALL
${normal}"

mkdir -p $GITCLONEDIR
cd $GITCLONEDIR
git clone $GITREPO
cd $GITREPOROOT

#sudo -H pip2 install pyopenSSL==17.0.0 joe  PyGithub GitPython futures pyOpenSSL lxml scapy-real guess-language ruamel.ordereddict tldextract

#sudo -H pip2 install   odict Jinja2 pyClamd PyGithub GitPython nltk chardet tblib futures pyOpenSSL ndg-httpsclient lxml scapy-real==2.2.0-dev guess-language msgpack-python python-ntlm darts.util.lru Jinja2 markdown psutil mitmproxy ruamel.ordereddict PyYAML tldextract
#sudo ldconfig
#sudo updatedb

cd $GITREPOROOT
GITSBMDLINIT

# Lets do this with virtualenv ....

# write an install script for the venv routine and run it for each
echo '#!/bin/bash

cd /opt/ITSEC/2.Vulnerability-Scanner/w3af/andresriancho/w3af

virtualenv venv
. venv/bin/activate
./w3af_console
. /tmp/user/1000/w3af_dependency_install.sh' > installvenv_w3af_console.sh

chmod +x installvenv_w3af_console.sh
./installvenv_w3af_console.sh

echo '#!/bin/bash

cd /opt/ITSEC/2.Vulnerability-Scanner/w3af/andresriancho/w3af

virtualenv --system-site-packages venv
. venv/bin/activate
./w3af_gui
#. /tmp/user/1000/w3af_dependency_install.sh
. /tmp/w3af_dependency_install.sh' > installvenv_w3af_gui.sh

chmod +x installvenv_w3af_gui.sh
./installvenv_w3af_gui.sh



#cp /opt/ITSEC-Install-Scripts/2.Vulnerability-Scanner/w3af-files/requirements.py /opt/ITSEC/2.Vulnerability-Scanner/w3af/andresriancho/w3af/w3af/core/controllers/dependency_check/requirements.py

echo '#!/bin/bash

cd /opt/ITSEC/2.Vulnerability-Scanner/w3af/andresriancho/w3af

. venv/bin/activate
./w3af_console "$@"' > $EXECUTEABLE1SH

chmod +x $EXECUTEABLE1SH

echo '#!/bin/bash

cd /opt/ITSEC/2.Vulnerability-Scanner/w3af/andresriancho/w3af

. venv/bin/activate 
./w3af_gui "$@"' > $EXECUTEABLE1GUISH

chmod +x $EXECUTEABLE1GUISH
sudo rm -f $BINDIR/$EXECUTEABLE1
sudo rm -f $BINDIR/$EXECUTEABLE1GUI
sudo ln -s $GITREPOROOT/$EXECUTEABLE1SH $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1GUISH $BINDIR/$EXECUTEABLE1GUI
#cd /opt/ITSEC/7.Mitm/7.Mitm/mitmproxy python-git python3-git
#sudo apt-get purge --remove python-enum34
#sudo -H pip2 install enum34 twisted

rm -f  $DSKTPFLSDEST/$DSKTPFL
mkdir -p $DSKTPFLSDEST
cp $DSKTPFLS/$DSKTPFL $DSKTPFLSDEST/$DSKTPFL

