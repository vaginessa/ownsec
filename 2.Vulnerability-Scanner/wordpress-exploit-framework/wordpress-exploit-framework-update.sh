#!/bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

GITREPO=https://github.com/rastating/wordpress-exploit-framework
BRANCH=master
GITREPOROOT=/opt/ITSEC/2.Vulnerability-Scanner/wordpress-exploit-framework/rastating/wordpress-exploit-framework
GITCONFDIR=/opt/ITSEC/2.Vulnerability-Scanner/wordpress-exploit-framework/rastating/wordpress-exploit-framework
GITREPOBINDIR=/opt/ITSEC/2.Vulnerability-Scanner/wordpress-exploit-framework/rastating/wordpress-exploit-framework/bin
GITCLONEDIR=/opt/ITSEC/2.Vulnerability-Scanner/wordpress-exploit-framework/rastating
EXECUTEABLE1=wpxf.sh 
EXECUTEABLE2=wordpress-exploit-framework
BINDIR=/usr/local/bin
DSKTPFLS=/opt/ITSEC-Install-Scripts/0.Initial/usrlcl/.local/share/applications/2.Vulnerability-Scanner
DSKTPFLSDEST=/home/$USER/.local/share/applications/2.Vulnerability-Scanner
DSKTPFL=wordpress-exploit-framework.desktop
GITRESET () {
	git clean -f
	git fetch origin
	git reset --hard origin/$BRANCH
	git pull
}
APTLSTDIR=/opt/ITSEC-Install-Scripts/0.Initial/lst/apt
GITSBMDLINIT () {
	git submodule init
	git submodule update --recursive
	sudo updatedb && sudo ldconfig
}

echo "${bold}
__        ______       _______  __     _____ __  ____        ______  _  __
\ \      / /  _ \     | ____\ \/ /    |  ___|  \/  \ \      / /  _ \| |/ /
 \ \ /\ / /| |_) |____|  _|  \  /_____| |_  | |\/| |\ \ /\ / /| |_) | ' / 
  \ V  V / |  __/_____| |___ /  \_____|  _| | |  | | \ V  V / |  _ <| . \ 
   \_/\_/  |_|        |_____/_/\_\    |_|   |_|  |_|  \_/\_/  |_| \_\_|\_\
                                                                                    
UPDATE                                   
${normal}"

if [ ! -d $GITCONFDIR ]

then

mkdir -p $GITCLONEDIR
cd $GITCLONEDIR
git clone -b $BRANCH $GITREPO

else

echo "${bold}REPO EXISTS, skip clone...${normal}"

fi

cd $GITREPOROOT

if git checkout $BRANCH &&
    git fetch origin $BRANCH &&
    [ `git rev-list HEAD...origin/$BRANCH --count` != 0 ] &&
    git merge origin/$BRANCH
then
    
cd $GITREPOROOT

sudo apt-get install build-essential patch
sudo apt-get install ruby-dev zlib1g-dev liblzma-dev

. ~/.bashrc
eval "$(rbenv init -)"
yes "N" | rbenv install 2.4.1 
rbenv rehash
rbenv shell 2.4.1 
sudo updatedb
sudo ldconfig

GITRESET
GITSBMDLINIT
gem install bundler
bundle update
bundle install
#gem uninstall arachni
#gem install arachni
#gem install rake
#cd $GITREPOBINDIR

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/wordpress-exploit-framework/rastating/wordpress-exploit-framework

source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.4.1
ruby wpxf.rb "$@"
' > $EXECUTEABLE1 

chmod +x $GITREPOROOT/$EXECUTEABLE1
sudo rm -f $BINDIR/$EXECUTEABLE2
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE2

rm -f $DSKTPFLSDEST/$DSKTPFL
mkdir -p $DSKTPFLSDEST
cp $DSKTPFLS/$DSKTPFL $DSKTPFLSDEST/$DSKTPFL


fi
