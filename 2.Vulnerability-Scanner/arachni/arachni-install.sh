#!/bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

GITREPO=https://github.com/Arachni/arachni.git
BRANCH=master
GITREPOROOT=/opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni
GITREPOBINDIR=/opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
GITCLONEDIR=/opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni
BINDIR=/usr/local/bin
DSKTPFLS=/opt/ITSEC-Install-Scripts/0.Initial/usrlcl/.local/share/applications/2.Vulnerability-Scanner
DSKTPFLSDEST=/home/$USER/.local/share/applications/2.Vulnerability-Scanner
DSKTPFL=arachni.desktop
APTLSTDIR=/opt/ITSEC-Install-Scripts/0.Initial/lst/apt
GITSBMDLINIT () {
	git submodule init
	git submodule update --recursive
	sudo updatedb && sudo ldconfig
}

echo "${bold}
    _    ____      _    ____ _   _ _   _ ___ 
   / \  |  _ \    / \  / ___| | | | \ | |_ _|
  / _ \ | |_) |  / _ \| |   | |_| |  \| || | 
 / ___ \|  _ <  / ___ \ |___|  _  | |\  || | 
/_/   \_\_| \_\/_/   \_\____|_| |_|_| \_|___|
       
INSTALL
${normal}"

mkdir -p $GITCLONEDIR
cd $GITCLONEDIR
git clone -b $BRANCH $GITREPO
cd $GITREPOROOT

### DEPS:
## Installed w apt lists - see /opt/ITSEC-Install-Scripts/0.Initial/lst/apt
# sudo apt-get update
# sudo apt-get upgrade
# xargs -a <(awk '/^\s*[^#]/' "$APTLSTDIR/deps-arachni.txt") -r -- sudo apt-get install -y

. ~/.bashrc
eval "$(rbenv init -)"
yes "N" | rbenv install 2.3.3
rbenv rehash
sudo updatedb
sudo ldconfig
rbenv shell 2.3.3
### DEPS END

APTLSTDIR=/opt/ITSEC-Install-Scripts/0.Initial/lst/apt
GITSBMDLINIT

gem install bundler
bundle update
bundle install
yes "y" | gem install arachni
gem install rake
cd $GITREPOBINDIR

#ARACHNI=arachni
#ARACHNI_CONSOLE=arachni_console
#ARACHNI_MULTI=arachni_multi
#ARACHNI_REPORTER=arachni_reporter
#ARACHNI_RESTORE=arachni_restore
#ARACHNI_REPRODUCE=arachni_reproduce 
#ARACHNI_REST_SERVER=arachni_rest_server
#ARACHNI_RPC=arachni_rpc
#ARACHNI_RPCD=arachni_rpcd
#ARACHNI_RPCD_MONITOR=arachni_rpcd_monitor
#ARACHNI_SCRIPT=arachni_script
#sudo bash -c 'for ARACHNI in $(ls arachni*); do ln -s /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin/$ARACHNI $BINDIR/$ARACHNI;done'


echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni "$@"
' > arachni.sh 

chmod +x $GITREPOBINDIR/arachni.sh
sudo rm -f $BINDIR/arachni
sudo rm -f $BINDIR/arachni.sh
sudo ln -s $GITREPOBINDIR/arachni.sh $BINDIR/arachni.sh

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni_console "$@"
' > arachni_console.sh 

chmod +x $GITREPOBINDIR/arachni_console.sh
sudo rm -f $BINDIR/arachni_console.sh
sudo ln -s $GITREPOBINDIR/arachni_console.sh $BINDIR/arachni_console.sh

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni_multi "$@"
' > arachni_multi.sh 

chmod +x $GITREPOBINDIR/arachni_multi.sh
sudo rm -f $BINDIR/arachni_multi.sh
sudo ln -s $GITREPOBINDIR/arachni_multi.sh $BINDIR/arachni_multi.sh

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni_reporter "$@"
' > arachni_reporter.sh 

chmod +x $GITREPOBINDIR/arachni_reporter.sh
sudo rm -f $BINDIR/arachni_reporter.sh
sudo ln -s $GITREPOBINDIR/arachni_reporter.sh $BINDIR/arachni_reporter.sh

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni_restore "$@"
' > arachni_restore.sh 

chmod +x $GITREPOBINDIR/arachni_restore.sh
sudo rm -f $BINDIR/arachni_restore.sh
sudo ln -s $GITREPOBINDIR/arachni_restore.sh $BINDIR/arachni_restore.sh

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni_reproduce "$@"
' > arachni_reproduce.sh 

chmod +x $GITREPOBINDIR/arachni_reproduce.sh
sudo rm -f $BINDIR/arachni_reproduce.sh
sudo ln -s $GITREPOBINDIR/arachni_reproduce.sh $BINDIR/arachni_reproduce.sh

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni_rest_server "$@"
' > arachni_rest_server.sh 

chmod +x $GITREPOBINDIR/arachni_rest_server.sh
sudo rm -f $BINDIR/arachni_rest_server.sh
sudo ln -s $GITREPOBINDIR/arachni_rest_server.sh $BINDIR/arachni_rest_server.sh

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni_rpc "$@"
' > arachni_rpc.sh 

chmod +x $GITREPOBINDIR/arachni_rpc.sh
sudo rm -f $BINDIR/arachni_rpc.sh
sudo ln -s $GITREPOBINDIR/arachni_rpc.sh $BINDIR/arachni_rpc.sh

#sudo ln -s $GITREPOBINDIR/arachni_rpcd $BINDIR/arachni_rpcd 
#sudo ln -s $GITREPOBINDIR/arachni_rpcd_monitor $BINDIR/arachni_rpcd_monitor

echo '#!/bin/bash 

cd /opt/ITSEC/2.Vulnerability-Scanner/arachni/Arachni/arachni/bin
source ~/.bashrc
eval "$(rbenv init -)"
rbenv shell 2.3.3 
./arachni_script "$@"
' > arachni_script.sh 

chmod +x $GITREPOBINDIR/arachni_script.sh
sudo rm -f $BINDIR/arachni_script.sh
sudo ln -s $GITREPOBINDIR/arachni_script.sh $BINDIR/arachni_script.sh

mkdir -p $DSKTPFLSDEST
cp $DSKTPFLS/$DSKTPFL $DSKTPFLSDEST/$DSKTPFL



